07 | 行锁功过：怎么减少行锁对性能的影响？

这篇讲行锁。

行锁是InnoDB独有的，MyISAM没有。


## 两阶段锁协议

在InnoDB事务中，行锁是在需要时才加上，但并不是不需要了立即释放，而是需要等待事务执行完才会释放。

在事务里面，把最容易加锁的行更新放在最后。

## 死锁与死锁检测



在死锁时，可以设定一个超时时间，```innodb_lock_wait_timeout```这个值可以设置超时时间，但这不是最好的办法，因为死锁时间不好掌握。




更好的办法是设置```innodb_deadlock_detect```为on，但在线程特别多时，这个死锁检测特别耗CPU。

时间复杂度是O(n)

所以要限制连接线程数。


## 问题

要删除10000行数据，有三种方法，哪个好？

1. delete from T limit 10000;
2. 在一个连接中循环执行20次 delete from T limit 500;
3. 在20个连接中执行 delete from T limit 500;


第一种执行的时间比较长，需要的资源比较多，占用锁的时间比较长。
第三种多个线程连接，需要更多的死锁检测。

所以是第二种。

