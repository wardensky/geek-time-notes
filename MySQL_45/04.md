# 04 | 深入浅出索引（上）


这篇讲索引的上半部分，区分了哈希、有序数组和搜索树，都是数据结构中的常见知识，证明了搜索树比较适合数据库索引，而且二叉树不行，要多叉树。

## InnoDB的索引模型

众所周知，InnoDB用的是B+树。

>B+ 树的特点是能够保持数据稳定有序，其插入与修改拥有较稳定的对数时间复杂度。

主键索引中，叶子节点的内容是整航数据。

非主键索引中，叶子节点存储的是主键的值。

基于非主键索引的搜索，需要先查询费主键索引，再查询主键索引，这个过程叫回表。

![](images/04-1.png)


## 索引维护

B+树有顺序，为了维护B+树，在增加新页面时，涉及到页分裂。在删除数据时，涉及到页合并。

因此，很多情况下，推荐用自增做主键。

1. 不涉及页分裂的问题。
2. 主键比较小，非主键索引占的空间小。


## 问题

重建索引或者重建主键索引，通过drop和add好不好

```
alter table T drop index k;
alter table T add index(k);


alter table T drop primary key;
alter table T add primary key(id);
```

重建索引是对的，但上述语法不合理，可用以下语句替换。

```
alter table T engine=InnoDB
```


## 一个有趣的案例

>老师的每一篇都会讲到平常工作用遇到的事情. 这个专栏真的很值.
>今天这个 alter table T engine=InnoDB 让我想到了我们线上的一个表, 记录日志用的, 会定期删除过早之前的数据. 最后这个表实际内容的大小才10G, 而他的索引却有30G. 在阿里云控制面板上看,就是占了40G空间. 这可花的是真金白银啊.
>后来了解到是 InnoDB 这种引擎导致的,虽然删除了表的部分记录,但是它的索引还在, 并未释放.只能是重新建表才能重建索引.